import{u as P,r as a,j as e,Y as F,at as D,p as _,aB as T,f as O,h as U}from"./main-CkvTh2wP.js";const W=({isOpen:f,onClose:y,mode:n})=>{const{user:G,saveFaceDescriptor:j,loginWithFace:w}=P(),[r,s]=a.useState("INITIALIZING_MODELS"),[E,c]=a.useState("Loading AI models..."),[b,u]=a.useState(""),[m,A]=a.useState(""),i=a.useRef(null),x=a.useRef(null),C=a.useRef(!1),o=a.useRef(null),h=a.useCallback(()=>{x.current&&(x.current.getTracks().forEach(t=>t.stop()),x.current=null),o.current&&(clearInterval(o.current),o.current=null),s("INITIALIZING_MODELS"),c("Loading AI models..."),u(""),A("")},[]),d=a.useCallback(()=>{h(),y()},[h,y]),N=a.useCallback(async()=>{if(C.current)return!0;try{if(typeof faceapi>"u")throw new Error("Face recognition library is not loaded.");const t="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/";return await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(t),faceapi.nets.faceLandmark68Net.loadFromUri(t),faceapi.nets.faceRecognitionNet.loadFromUri(t)]),C.current=!0,!0}catch(t){return console.error("Model loading error:",t),s("ERROR"),u("Could not load AI models required for face recognition. Please check your internet connection and try again."),!1}},[]),S=async()=>{try{const t=await navigator.permissions.query({name:"camera"});t.state==="granted"?s(n==="register"||n==="signup_redirect"?"CAMERA_ACTIVE":"EMAIL_INPUT"):t.state==="denied"?s("PERMISSION_DENIED"):s("AWAITING_PERMISSION")}catch{s("AWAITING_PERMISSION")}};a.useEffect(()=>{(async()=>{f?(s("INITIALIZING_MODELS"),c("Loading AI models..."),await N()&&await S()):h()})()},[f,N,h]);const v=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});x.current=t,i.current&&(i.current.srcObject=t),s(n==="register"||n==="signup_redirect"?"CAMERA_ACTIVE":"EMAIL_INPUT")}catch{s("PERMISSION_DENIED")}},R=a.useCallback(async()=>{if(o.current&&clearInterval(o.current),!i.current)return;c("Position your face in the oval");const t=async()=>{if(!i.current||i.current.paused)return;const l=await faceapi.detectAllFaces(i.current,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();if(l.length===0){c("No face detected");return}if(l.length>1){c("Multiple faces detected");return}c("Hold still...");const g=l[0].descriptor;if(n==="register"){s("PROCESSING"),c("Saving your face data...");try{await j(Array.from(g)),s("SUCCESS"),setTimeout(d,2e3)}catch(p){s("ERROR"),u(p.message||"Failed to save face data.")}}else{s("PROCESSING"),c("Verifying...");try{const I=await D.collection("users").where("email","==",m.trim()).limit(1).get();if(I.empty||!I.docs[0].data().faceDescriptor)throw new Error("Face Login is not set up for this account.");const M=new Float32Array(I.docs[0].data().faceDescriptor);faceapi.euclideanDistance(M,g)<.5?(c("Face matched! Logging in..."),await w(m),s("SUCCESS"),setTimeout(d,1500)):(s("ERROR"),u("Face not recognized. Please try again."))}catch(p){s("ERROR"),u(p.message||"Verification failed.")}}};if(n==="register"){const l=document.getElementById("capture-face-btn");l&&(l.onclick=()=>{o.current&&clearInterval(o.current),t()})}else o.current=window.setInterval(t,2500)},[m,d,w,n,j]);a.useEffect(()=>{r==="CAMERA_ACTIVE"&&i.current&&(i.current.onplaying=()=>{R()})},[r,R]);const k=t=>{if(t.preventDefault(),!m.trim()||!m.includes("@")){u("Please enter a valid email address.");return}u(""),s("CAMERA_ACTIVE")},L=()=>{const t=r==="CAMERA_ACTIVE"||r==="PROCESSING",l=n==="register"?"Set Up Face Login":"Continue with Face ID";return e.jsxs(e.Fragment,{children:[e.jsxs("header",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold",children:l}),e.jsx("button",{onClick:d,className:"text-gray-500 hover:text-gray-800",children:e.jsx(_,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6",children:[r==="INITIALIZING_MODELS"&&e.jsxs("div",{className:"text-center py-10",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-red mx-auto"}),e.jsx("p",{className:"mt-4 font-semibold",children:E})]}),r==="AWAITING_PERMISSION"&&e.jsxs("div",{className:"text-center py-6",children:[e.jsx(T,{className:"h-12 w-12 mx-auto text-blue-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Enable Camera Access"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"We need permission to use your camera for face recognition."}),e.jsx("button",{onClick:v,className:"mt-6 w-full bg-brand-red text-white font-bold py-2.5 rounded-md",children:"Grant Permission"})]}),r==="PERMISSION_DENIED"&&e.jsxs("div",{className:"text-center py-6",children:[e.jsx(O,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Camera Access Denied"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"Please enable camera access in your browser's site settings, then try again."}),e.jsx("button",{onClick:d,className:"mt-6 w-full bg-gray-600 text-white font-bold py-2.5 rounded-md",children:"Close"})]}),r==="EMAIL_INPUT"&&e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsx("label",{htmlFor:"face-login-email",className:"block text-sm font-medium",children:"Email Address"}),e.jsx("input",{type:"email",id:"face-login-email",value:m,onChange:g=>A(g.target.value),required:!0,className:"w-full mt-1 p-2 border rounded-md",placeholder:"you@example.com"}),b&&e.jsx("p",{className:"text-sm text-red-500",children:b}),e.jsx("button",{type:"submit",className:"w-full bg-brand-red text-white font-bold py-2.5 rounded-md",children:"Continue"})]}),t&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"relative w-full max-w-[240px] aspect-[3/4] mx-auto bg-black rounded-lg overflow-hidden border",children:[e.jsx("video",{ref:i,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover transform -scale-x-100"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-[75%] h-[85%] border-4 border-white/50 rounded-[50%] animate-pulse"})}),r==="PROCESSING"&&e.jsx("div",{className:"absolute inset-0 bg-black/70 flex flex-col items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})})]}),e.jsx("p",{className:"mt-4 font-semibold h-5",children:E}),n==="register"&&r==="CAMERA_ACTIVE"&&e.jsx("button",{id:"capture-face-btn",className:"w-full mt-4 bg-brand-red text-white font-bold py-2 rounded-md",children:"Capture Face"})]}),r==="SUCCESS"&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h3",{className:"font-bold text-lg text-green-600",children:"Success!"}),e.jsx("p",{className:"mt-2",children:n==="register"?"Face Login has been set up.":"Logged in successfully!"})]}),r==="ERROR"&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("h3",{className:"font-bold text-lg text-red-500",children:"An Error Occurred"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:b}),e.jsxs("button",{onClick:()=>N().then(S),className:"mt-4 flex items-center justify-center gap-2 w-full bg-gray-200 font-bold py-2.5 rounded-md",children:[e.jsx(U,{className:"h-5 w-5"})," Try Again"]})]})]})]})};return n==="signup_redirect"&&f?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:d,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl p-6 text-center",onClick:t=>t.stopPropagation(),children:[e.jsx(F,{className:"h-10 w-10 mx-auto text-brand-red mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Set Up Face Login After Sign Up"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["Please complete the sign-up process first. You can then enable Face Login from your ",e.jsx("strong",{children:"Account Settings"})," page."]}),e.jsx("button",{onClick:d,className:"mt-4 w-full bg-brand-red text-white font-bold py-2 px-4 rounded-md",children:"Got it"})]})}):f?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:d,children:e.jsx("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl",onClick:t=>t.stopPropagation(),children:L()})}):null};export{W as F};
