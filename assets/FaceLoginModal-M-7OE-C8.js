import{u as I,r,j as e,Y as L,at as P}from"./main-SNTVbf7n.js";const z=({isOpen:m,onClose:i,mode:l})=>{const{user:A,saveFaceDescriptor:b,loginWithFace:y}=I(),[w,a]=r.useState("Loading AI models..."),[g,c]=r.useState(""),[d,j]=r.useState(""),[u,v]=r.useState(l==="register"?2:1),s=r.useRef(null),F=r.useRef(null),f=r.useRef(null),o=r.useRef(null),N=async()=>{try{if(typeof faceapi>"u")throw new Error("Face-api.js script not loaded yet.");await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri("/models"),faceapi.nets.faceLandmark68Net.loadFromUri("/models"),faceapi.nets.faceRecognitionNet.loadFromUri("/models")]),a(l==="register"?"Initializing camera...":"Please enter your email")}catch(t){console.error("Model loading error:",t),c("Could not load AI models. Please check your connection and refresh.")}},k=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({video:{}});f.current=t,s.current&&(s.current.srcObject=t)}catch{c("Camera access is required. Please enable it in your browser settings."),a("")}};r.useEffect(()=>(m&&(N(),u===2&&k()),()=>{f.current?.getTracks().forEach(t=>t.stop()),f.current=null,o.current&&(clearInterval(o.current),o.current=null)}),[m,u]);const h=async t=>{if(!s.current||s.current.paused||s.current.error||typeof faceapi>"u")return;const n=await faceapi.detectAllFaces(s.current,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptors();if(n.length===0){a("No face detected. Please position yourself clearly.");return}if(n.length>1){a("Multiple faces detected. Please ensure only one person is in frame.");return}t(n[0].descriptor)},E=async()=>{a("Capturing your face..."),await h(async t=>{a("Saving your face data...");try{await b(Array.from(t)),a("Face login setup complete! ✅"),setTimeout(i,2e3)}catch(n){c(n.message||"Could not save face data."),a("")}})},D=async t=>{if(t?.preventDefault(),!d){c("Email is required.");return}a("Finding your account..."),c("");try{const p=await P.collection("users").where("email","==",d).limit(1).get();if(p.empty)throw new Error("No account found with this email.");const x=p.docs[0].data();if(!x.faceDescriptor)throw new Error("Face Login is not set up for this account. Please set it up in Account Settings.");const R=new Float32Array(x.faceDescriptor);v(2),s.current?.addEventListener("play",()=>{o.current=window.setInterval(async()=>{await h(async S=>{if(faceapi.euclideanDistance(R,S)<.6){o.current&&clearInterval(o.current),a("Face matched! Logging you in... ✅");try{await y(d),setTimeout(i,1e3)}catch(C){c(C.message),a("")}}else a("Face not recognized. Trying again... ❌")})},2e3)})}catch(n){c(n.message),a("Please enter your email")}};return m?l==="signup_redirect"?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl p-6 text-center",onClick:t=>t.stopPropagation(),children:[e.jsx(L,{className:"h-10 w-10 mx-auto text-brand-red mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Set Up Face Login"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["To use Face ID, please sign up with another method first. You can then enable Face Login from your ",e.jsx("strong",{children:"Account Settings"})," page."]}),e.jsx("button",{onClick:i,className:"mt-4 w-full bg-brand-red text-white font-bold py-2 px-4 rounded-md",children:"Got it"})]})}):e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-md rounded-lg shadow-xl",onClick:t=>t.stopPropagation(),children:[e.jsxs("header",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold",children:l==="register"?"Set Up Face Login":"Continue with Face ID"}),e.jsx("button",{onClick:i,className:"text-2xl",children:"×"})]}),e.jsxs("div",{className:"p-6",children:[u===1&&e.jsxs("form",{onSubmit:D,children:[e.jsx("label",{htmlFor:"face-login-email",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Email Address"}),e.jsx("input",{type:"email",id:"face-login-email",value:d,onChange:t=>j(t.target.value),required:!0,className:"w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-black"}),e.jsx("button",{type:"submit",className:"w-full mt-4 bg-brand-red text-white font-bold py-2 rounded-md",children:"Continue"})]}),u===2&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"relative w-64 h-48 mx-auto bg-black rounded-md overflow-hidden border",children:[e.jsx("video",{ref:s,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover transform -scale-x-100"}),e.jsx("canvas",{ref:F,className:"absolute top-0 left-0"})]}),l==="register"&&e.jsx("button",{onClick:E,className:"w-full mt-4 bg-brand-red text-white font-bold py-2 rounded-md",children:"Capture and Save Face"})]}),e.jsx("p",{className:"text-center text-sm font-semibold mt-4 min-h-[20px]",children:w}),g&&e.jsx("p",{className:"text-center text-sm text-red-500 mt-2",children:g})]})]})}):null};export{z as F};
