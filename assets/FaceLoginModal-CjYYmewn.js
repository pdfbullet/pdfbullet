import{u as q,r as s,j as e,Y as T,aB as M,f as U,at as z}from"./main-B0JIBXt1.js";const _=({isOpen:c,onClose:i,mode:u})=>{const{user:Y,saveFaceDescriptor:k,loginWithFace:F}=q(),[f,o]=s.useState("checking"),[p,a]=s.useState("Loading..."),[b,n]=s.useState(""),[h,C]=s.useState(""),[g,m]=s.useState(1),l=s.useRef(null),x=s.useRef(null),d=s.useRef(null),y=s.useRef(!1),w=s.useCallback(async()=>{if(!navigator.permissions){o("prompt");return}try{const t=await navigator.permissions.query({name:"camera"});o(t.state),t.onchange=()=>o(t.state)}catch(t){console.warn("Camera permission query not supported, falling back to prompt.",t),o("prompt")}},[]),E=async()=>{a("Requesting camera access..."),n("");try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(r=>r.stop()),o("granted")}catch(t){t instanceof DOMException&&t.name==="NotAllowedError"?(n("Camera access was denied. Please enable it in your browser settings."),o("denied")):n("Could not access the camera. Please ensure it is not in use by another application.")}},D=async()=>{a("Initializing camera...");try{const t=await navigator.mediaDevices.getUserMedia({video:{}});x.current=t,l.current&&(l.current.srcObject=t)}catch{n("Camera access is required. Please enable it in your browser settings."),o("denied"),m(1)}};s.useEffect(()=>(c&&(async()=>{if(!(y.current||typeof faceapi>"u"))try{await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri("/models"),faceapi.nets.faceLandmark68Net.loadFromUri("/models"),faceapi.nets.faceRecognitionNet.loadFromUri("/models")]),y.current=!0,w()}catch{n("Could not load AI models. Please check your connection and refresh.")}})(),()=>{x.current?.getTracks().forEach(r=>r.stop()),x.current=null,d.current&&(clearInterval(d.current),d.current=null)}),[c,w]),s.useEffect(()=>{c&&f==="granted"?u==="register"?m(2):(a("Please enter your email"),m(1)):c&&f!=="checking"&&(a(""),m(1))},[c,f,u]),s.useEffect(()=>{c&&g===2&&D()},[c,g]);const j=async t=>{if(!l.current||l.current.paused||typeof faceapi>"u")return;const r=await faceapi.detectAllFaces(l.current,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptors();if(r.length===0){a("No face detected. Move closer to the camera.");return}if(r.length>1){a("Multiple faces detected. Please ensure only one person is in frame.");return}t(r[0].descriptor)},P=async()=>{a("Hold still, capturing your face..."),await j(async t=>{a("Saving your face data...");try{await k(Array.from(t)),a("Face login setup complete! ✅"),setTimeout(i,2e3)}catch(r){n(r.message||"Could not save face data."),a("")}})},S=async t=>{if(t?.preventDefault(),!h.trim()){n("Email address is required to find your account.");return}a("Finding your account..."),n("");try{const v=await z.collection("users").where("email","==",h.trim()).limit(1).get();if(v.empty)throw new Error("No account found with this email.");const N=v.docs[0].data();if(!N.faceDescriptor)throw new Error("Face Login is not set up for this account. Please set it up in your Account Settings.");const R=new Float32Array(N.faceDescriptor);m(2),l.current?.addEventListener("play",()=>{a("Position your face in the oval..."),d.current=window.setInterval(async()=>{await j(async I=>{if(faceapi.euclideanDistance(R,I)<.5){d.current&&clearInterval(d.current),a("Face matched! Logging you in... ✅");try{await F(h),setTimeout(i,1500)}catch(A){n(A.message),a("")}}else a("Face not recognized. Trying again...")})},2500)})}catch(r){n(r.message),a("Please enter your email")}},L=()=>{if(g===1)switch(f){case"checking":return e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-red mx-auto"}),e.jsx("p",{className:"mt-4",children:p})]});case"denied":return e.jsxs("div",{className:"text-center p-8",children:[e.jsx(U,{className:"h-10 w-10 mx-auto text-red-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Camera Access Denied"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"To use Face Login, you need to allow camera access in your browser settings. Please update your settings and try again."}),e.jsx("button",{onClick:i,className:"mt-4 w-full bg-gray-600 text-white font-bold py-2 rounded-md",children:"Close"})]});case"prompt":return e.jsxs("div",{className:"text-center p-8",children:[e.jsx(M,{className:"h-10 w-10 mx-auto text-blue-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Camera Access Required"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"This feature needs access to your camera to scan your face."}),e.jsx("button",{onClick:E,className:"mt-4 w-full bg-brand-red text-white font-bold py-2 rounded-md",children:"Enable Camera"})]});case"granted":return e.jsxs("form",{onSubmit:S,className:"p-6 space-y-4",children:[e.jsx("label",{htmlFor:"face-login-email",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Email Address"}),e.jsx("input",{type:"email",id:"face-login-email",value:h,onChange:t=>C(t.target.value),required:!0,className:"w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-black",placeholder:"you@example.com"}),e.jsx("button",{type:"submit",className:"w-full bg-brand-red text-white font-bold py-2 rounded-md hover:bg-brand-red-dark transition-colors",children:"Continue"})]})}if(g===2)return e.jsxs("div",{className:"p-6 text-center",children:[e.jsxs("div",{className:"relative w-64 h-48 mx-auto bg-black rounded-lg overflow-hidden border border-gray-300 dark:border-gray-700",children:[e.jsx("video",{ref:l,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover transform -scale-x-100"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-40 h-56 border-4 border-white/50 rounded-[50%]"})})]}),u==="register"&&e.jsx("button",{onClick:P,className:"w-full mt-4 bg-brand-red text-white font-bold py-2 rounded-md",children:"Capture and Save Face"})]})};return c?u==="signup_redirect"?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl p-6 text-center",onClick:t=>t.stopPropagation(),children:[e.jsx(T,{className:"h-10 w-10 mx-auto text-brand-red mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Set Up Face Login"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["To use Face ID, please sign up with another method first. You can then enable Face Login from your ",e.jsx("strong",{children:"Account Settings"})," page."]}),e.jsx("button",{onClick:i,className:"mt-4 w-full bg-brand-red text-white font-bold py-2 px-4 rounded-md",children:"Got it"})]})}):e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:i,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-md rounded-lg shadow-xl",onClick:t=>t.stopPropagation(),children:[e.jsxs("header",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold",children:u==="register"?"Set Up Face Login":"Continue with Face ID"}),e.jsx("button",{onClick:i,className:"text-2xl font-light",children:"×"})]}),e.jsxs("div",{children:[L(),e.jsxs("div",{className:"px-6 pb-4 text-center text-sm font-semibold min-h-[44px]",children:[e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:p}),b&&e.jsx("p",{className:"text-red-500 mt-2",children:b})]})]})]})}):null};export{_ as F};
