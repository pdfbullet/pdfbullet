import{u as F,r as a,j as e,x as R,a2 as T,a6 as L,y as M,P as Q,aI as U}from"./main-C7NbxmL4.js";import*as O from"https://esm.sh/qrcode@1.5.3";import"./react-Ckhrjn13.js";const V=r=>{const i="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let n=0,l=0,o="";for(let d=0;d<r.length;d++)for(l=l<<8|r[d],n+=8;n>=5;)o+=i[l>>>n-5&31],n-=5;return n>0&&(o+=i[l<<5-n&31]),o},B=({isOpen:r,onClose:i})=>{const{user:n,updateTwoFactorStatus:l}=F(),[o,d]=a.useState(1),[N,v]=a.useState(""),[b,C]=a.useState(""),[x,y]=a.useState(""),[g,c]=a.useState(""),[u,m]=a.useState(!1),p=()=>{if(n?.username){const t=new Uint8Array(20);window.crypto.getRandomValues(t);const h=V(t);v(h);const w=`otpauth://totp/PDFBullet:${n.username}?secret=${h}&issuer=PDFBullet`;O.toDataURL(w,(j,k)=>{j?(console.error(j),c("Could not generate QR code. Please try again.")):C(k)})}};a.useEffect(()=>{r&&(d(1),c(""),y(""),p())},[r,n]);const f=async()=>{if(x.length!==6||!/^\d{6}$/.test(x)){c("Please enter a valid 6-digit code.");return}m(!0),c("");try{await l(!0),d(3)}catch(t){c(t.message||"An error occurred. Please try again."),m(!1)}};return r?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4",onClick:i,children:e.jsx("div",{className:"bg-white dark:bg-black w-full max-w-lg rounded-lg shadow-xl",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-center mb-4",children:"Set up Two-Factor Authentication"}),o===1&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"1. Scan this QR code with your authenticator app (like Google Authenticator)."}),b?e.jsx("img",{src:b,alt:"2FA QR Code",className:"mx-auto border-4 border-white dark:border-black rounded-lg"}):e.jsx("div",{className:"w-48 h-48 bg-gray-200 animate-pulse mx-auto"}),e.jsx("p",{className:"text-xs text-gray-500 mt-4",children:"Can't scan? Enter this code manually:"}),e.jsx("code",{className:"block mt-1 p-2 bg-gray-100 dark:bg-gray-800 rounded-md font-mono",children:N}),e.jsx("button",{onClick:()=>d(2),className:"mt-6 w-full bg-brand-red hover:bg-brand-red-dark text-white font-bold py-2 px-4 rounded-md",children:"Next Step"})]}),o===2&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"2. Enter the 6-digit code from your authenticator app to verify."}),e.jsx("input",{type:"text",value:x,onChange:t=>y(t.target.value),maxLength:6,placeholder:"123456",className:"w-48 p-2 text-2xl tracking-[0.5em] text-center border-2 border-gray-300 rounded-md"}),g&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:g}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{onClick:()=>d(1),className:"flex-1 bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-md",children:"Back"}),e.jsx("button",{onClick:f,disabled:u,className:"flex-1 bg-brand-red hover:bg-brand-red-dark text-white font-bold py-2 px-4 rounded-md disabled:bg-red-300",children:u?"Verifying...":"Verify & Enable"})]})]}),o===3&&e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 dark:bg-green-900/50 mb-6",children:e.jsx(R,{className:"h-10 w-10 text-green-600 dark:text-green-400"})}),e.jsx("h3",{className:"text-xl font-bold",children:"Success!"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-2",children:"Two-Factor Authentication has been enabled on your account."}),e.jsx("button",{onClick:i,className:"mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md",children:"Done"})]})]})})}):null},$=()=>{const{user:r,auth:i,updateTwoFactorStatus:n}=F(),{isWebAuthnSupported:l,register:o,getCredentials:d,removeCredential:N}=T(),[v,b]=a.useState([]),[C,x]=a.useState(!1),[y,g]=a.useState(!1),[c,u]=a.useState(!1),[m,p]=a.useState(!1),[f,t]=a.useState(""),[h,w]=a.useState(""),[j,k]=a.useState(!0),A=i.currentUser?.providerData.some(s=>s.providerId==="password"),S=async()=>{if(r){k(!0);try{const s=await d();b(s)}catch(s){console.error("Failed to fetch credentials:",s),t("Could not load passkeys.")}finally{k(!1)}}};a.useEffect(()=>{S()},[r]);const P=async()=>{if(window.confirm("Are you sure you want to disable Two-Factor Authentication? This will reduce your account's security.")){u(!0),t("");try{await n(!1)}catch(s){t(s.message||"Failed to disable 2FA.")}finally{u(!1)}}},D=async()=>{if(!r||!r.email){t("An email address is required to register a passkey.");return}p(!0),t(""),w("");try{await o(r.email),w("New passkey added successfully!"),await S()}catch(s){t(s.message||"Failed to register passkey.")}finally{p(!1)}},E=async s=>{if(window.confirm("Are you sure you want to remove this passkey? You will no longer be able to sign in with it.")){t("");try{await N(s),await S()}catch(I){t(I.message||"Could not remove passkey.")}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full space-y-8",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-extrabold text-gray-800 dark:text-gray-100",children:"Security"}),f&&e.jsx("p",{className:"mb-4 text-center text-sm text-red-500 bg-red-100 dark:bg-red-900/30 p-3 rounded-md",children:f}),h&&e.jsx("p",{className:"mb-4 text-center text-sm text-green-600 bg-green-100 dark:bg-green-900/30 p-3 rounded-md",children:h}),e.jsxs("div",{className:"bg-white dark:bg-surface-dark p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100 mb-4",children:"Passkeys"}),l?e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm mb-4",children:"Manage the passkeys (Face ID, fingerprint, security keys) used for passwordless sign-in."}),e.jsx("ul",{className:"space-y-3 mb-4",children:j?e.jsx("p",{className:"text-sm text-gray-500",children:"Loading passkeys..."}):v.map(s=>e.jsxs("li",{className:"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(L,{className:"h-6 w-6 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-sm",children:s.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Added: ",new Date(s.createdAt).toLocaleDateString()]})]})]}),e.jsx("button",{onClick:()=>E(s.id),className:"p-2 text-gray-400 hover:text-red-500",title:"Remove Passkey",children:e.jsx(M,{className:"h-5 w-5"})})]},s.id))}),e.jsxs("button",{onClick:D,disabled:m,className:"flex items-center gap-2 text-sm font-semibold bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 px-4 py-2 rounded-md transition-colors disabled:opacity-50",children:[e.jsx(Q,{className:"h-4 w-4"})," ",m?"Follow prompts...":"Add a new passkey"]})]}):e.jsx("p",{className:"text-sm text-yellow-600 bg-yellow-50 p-3 rounded-md",children:"Your browser or device does not support passkeys (WebAuthn)."})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-white dark:bg-surface-dark p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 flex flex-col",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100",children:"Password"}),e.jsx("div",{className:"flex-grow mt-2 text-gray-600 dark:text-gray-400",children:A?e.jsx("p",{children:"Change the password for your account."}):e.jsx("p",{children:"Your account was created using a social provider. You can create a password to enable email & password sign-in."})}),e.jsx("div",{className:"mt-4 text-right",children:e.jsx("button",{onClick:()=>x(!0),className:"text-sm font-semibold text-brand-red hover:underline",children:A?"Change":"Create"})})]}),e.jsxs("div",{className:"bg-white dark:bg-surface-dark p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 flex flex-col",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100",children:"Two factor authentication"}),e.jsxs("div",{className:"flex-grow mt-2 text-gray-600 dark:text-gray-400",children:[e.jsx("p",{className:"text-sm",children:"Improve your account security by requiring a second verification step at sign-in."}),e.jsxs("p",{className:"mt-2 text-sm",children:["Status:",e.jsx("span",{className:`font-bold ml-2 ${r?.twoFactorEnabled?"text-green-600 dark:text-green-400":"text-gray-500"}`,children:r?.twoFactorEnabled?"enabled":"disabled"})]})]}),e.jsx("div",{className:"mt-4 text-right",children:r?.twoFactorEnabled?e.jsx("button",{onClick:P,disabled:c,className:"text-sm font-semibold text-brand-red hover:underline disabled:opacity-50",children:c?"Disabling...":"Disable"}):e.jsx("button",{onClick:()=>g(!0),className:"text-sm font-semibold text-brand-red hover:underline",children:"Enable"})})]})]})]}),e.jsx(U,{isOpen:C,onClose:()=>x(!1)}),e.jsx(B,{isOpen:y,onClose:()=>g(!1)})]})};export{$ as default};
