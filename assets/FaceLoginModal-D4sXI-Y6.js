import{u as L,r,j as e,Y as _,p as P,f as T,aB as U,at as z}from"./main-DLtywukh.js";const B=({isOpen:f,onClose:l,mode:o})=>{const{user:O,saveFaceDescriptor:v,loginWithFace:S}=L(),[h,a]=r.useState("LOADING_MODELS"),[C,s]=r.useState("Initializing..."),[x,n]=r.useState(""),[u,b]=r.useState(""),i=r.useRef(null),m=r.useRef(null),d=r.useRef(null),p=r.useRef(!1),g=r.useCallback(()=>{m.current?.getTracks().forEach(t=>t.stop()),m.current=null,d.current&&(clearInterval(d.current),d.current=null),a("LOADING_MODELS"),s("Initializing..."),n(""),b("")},[]),E=r.useCallback(async()=>{if(n(""),a("LOADING_MODELS"),s("Initializing..."),typeof faceapi>"u"){n("Face recognition library could not be loaded. Please check your connection.");return}if(!p.current)try{await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri("/models"),faceapi.nets.faceLandmark68Net.loadFromUri("/models"),faceapi.nets.faceRecognitionNet.loadFromUri("/models")]),p.current=!0}catch{n("Could not load AI models. Please check your connection and refresh.");return}try{const t=await navigator.permissions.query({name:"camera"});t.state==="granted"?a(o==="register"?"CAMERA_ACTIVE":"NEEDS_EMAIL"):t.state==="denied"?a("PERMS_DENIED"):a("NEEDS_PERMS")}catch{a("NEEDS_PERMS")}},[o]);r.useEffect(()=>(f?E():g(),g),[f,E,g]);const D=async()=>{s("Initializing..."),n("");try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(c=>c.stop()),a(o==="register"?"CAMERA_ACTIVE":"NEEDS_EMAIL")}catch{a("PERMS_DENIED")}},y=r.useCallback(async()=>{if(!(m.current||!i.current)){s("Initializing...");try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});m.current=t,i.current&&(i.current.srcObject=t)}catch{n("Failed to start camera. Please ensure permissions are granted."),a("PERMS_DENIED")}}},[]);r.useEffect(()=>{h==="CAMERA_ACTIVE"&&y()},[h,y]);const N=async t=>{if(!i.current||i.current.paused||typeof faceapi>"u")return;const c=await faceapi.detectAllFaces(i.current,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptors();if(c.length===0){s("No face detected");return}if(c.length>1){s("Multiple faces detected");return}t(c[0].descriptor)},k=()=>{s("Hold still, capturing..."),N(async t=>{s("Saving your face data...");try{await v(Array.from(t)),a("SUCCESS"),setTimeout(l,2e3)}catch(c){n(c.message||"Could not save face data."),a("NEEDS_PERMS")}})},I=async t=>{if(t?.preventDefault(),!u.trim()){n("Email is required.");return}n("");try{const w=await z.collection("users").where("email","==",u.trim()).limit(1).get();if(w.empty)throw new Error("No account found with this email.");const j=w.docs[0].data();if(!j.faceDescriptor)throw new Error("Face Login is not set up for this account.");const M=new Float32Array(j.faceDescriptor);a("CAMERA_ACTIVE"),i.current?.addEventListener("play",()=>{s("Position your face in the oval"),d.current=window.setInterval(async()=>{s("Verifying..."),await N(async F=>{if(faceapi.euclideanDistance(M,F)<.5){d.current&&clearInterval(d.current),s("Face matched! Logging in...");try{await S(u),a("SUCCESS"),setTimeout(l,1500)}catch(R){n(R.message),a("NEEDS_EMAIL")}}else s("Face not recognized. Trying again...")})},2500)})}catch(c){n(c.message)}},A=()=>{switch(h){case"LOADING_MODELS":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-red mx-auto"}),e.jsx("p",{className:"mt-4",children:"Loading AI models..."})]});case"NEEDS_PERMS":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(U,{className:"h-12 w-12 mx-auto text-blue-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Camera Access Required"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"This feature needs your permission to use the camera for face recognition."}),e.jsx("button",{onClick:D,className:"mt-6 w-full bg-brand-red text-white font-bold py-2.5 rounded-md",children:"Enable Camera"})]});case"PERMS_DENIED":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(T,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Camera Access Denied"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"You've denied camera access. Please enable it in your browser's site settings to use this feature."}),e.jsx("button",{onClick:l,className:"mt-6 w-full bg-gray-600 text-white font-bold py-2.5 rounded-md",children:"Close"})]});case"NEEDS_EMAIL":return e.jsxs("form",{onSubmit:I,className:"p-6 space-y-4",children:[e.jsx("h3",{className:"font-bold text-center",children:"Continue with Face ID"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"face-login-email",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Enter your account email"}),e.jsx("input",{type:"email",id:"face-login-email",value:u,onChange:t=>b(t.target.value),required:!0,className:"w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-black",placeholder:"you@example.com"})]}),x&&e.jsx("p",{className:"text-sm text-red-500",children:x}),e.jsx("button",{type:"submit",className:"w-full bg-brand-red text-white font-bold py-2.5 rounded-md hover:bg-brand-red-dark",children:"Continue"})]});case"CAMERA_ACTIVE":return e.jsxs("div",{className:"p-6 text-center",children:[e.jsxs("div",{className:"relative w-64 h-48 mx-auto bg-black rounded-lg overflow-hidden border border-gray-300 dark:border-gray-700",children:[e.jsx("video",{ref:i,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover transform -scale-x-100"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-40 h-56 border-4 border-white/50 rounded-[50%]"})})]}),e.jsx("p",{className:"mt-4 font-semibold h-5",children:C}),o==="register"&&e.jsx("button",{onClick:k,className:"w-full mt-4 bg-brand-red text-white font-bold py-2 rounded-md",children:"Capture Face"})]});case"SUCCESS":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("h3",{className:"font-bold text-green-600",children:"Success!"}),e.jsx("p",{children:o==="register"?"Face login has been set up.":"You have been logged in."})]});default:return null}};return f?o==="signup_redirect"?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl p-6 text-center",onClick:t=>t.stopPropagation(),children:[e.jsx(_,{className:"h-10 w-10 mx-auto text-brand-red mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Set Up Face Login After Sign Up"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["Please sign up with another method first. You can then enable Face Login from your ",e.jsx("strong",{children:"Account Settings"})," page."]}),e.jsx("button",{onClick:l,className:"mt-4 w-full bg-brand-red text-white font-bold py-2 px-4 rounded-md",children:"Got it"})]})}):e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl",onClick:t=>t.stopPropagation(),children:[e.jsxs("header",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold",children:o==="register"?"Set Up Face Login":"Continue with Face ID"}),e.jsx("button",{onClick:l,className:"text-gray-500 hover:text-gray-800",children:e.jsx(P,{className:"h-6 w-6"})})]}),A()]})}):null};export{B as F};
