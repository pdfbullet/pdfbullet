import{u as P,r,at as D,j as e,Y as L,p as M,h as T,f as _,aB as U}from"./main-DebOd4xP.js";const V=({isOpen:f,onClose:I,mode:n})=>{const{user:O,saveFaceDescriptor:y,loginWithFace:w}=P(),[h,a]=r.useState("INITIALIZING"),[v,c]=r.useState("Initializing..."),[b,s]=r.useState(""),[u,j]=r.useState(""),i=r.useRef(null),x=r.useRef(null),o=r.useRef(null),E=r.useRef(!1),g=r.useCallback(()=>{x.current&&(x.current.getTracks().forEach(t=>t.stop()),x.current=null),o.current&&(clearInterval(o.current),o.current=null),a("INITIALIZING"),c("Initializing..."),s(""),j("")},[]),l=r.useCallback(()=>{g(),I()},[g,I]),p=r.useCallback(async()=>{if(s(""),a("INITIALIZING"),typeof faceapi>"u"){a("ERROR"),s("Face recognition library could not be loaded. Please check your connection and refresh the page.");return}if(!E.current)try{await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri("/models"),faceapi.nets.faceLandmark68Net.loadFromUri("/models"),faceapi.nets.faceRecognitionNet.loadFromUri("/models")]),E.current=!0}catch{a("ERROR"),s("Could not load AI models required for face recognition. Please check your connection.");return}try{const t=await navigator.permissions.query({name:"camera"});t.state==="granted"?a(n==="register"?"CAMERA_ACTIVE":"EMAIL_INPUT"):t.state==="denied"?a("PERMISSION_DENIED"):a("AWAITING_PERMISSION")}catch{a("AWAITING_PERMISSION")}},[n]);r.useEffect(()=>{f?p():g()},[f,p,g]);const R=async()=>{s("");try{const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});x.current=t,i.current&&(i.current.srcObject=t),a(n==="register"?"CAMERA_ACTIVE":"EMAIL_INPUT")}catch(t){console.error("Camera permission error:",t),a("PERMISSION_DENIED")}},C=r.useCallback(()=>{o.current&&clearInterval(o.current);const t=async()=>{if(!i.current||i.current.paused)return null;const d=await faceapi.detectSingleFace(i.current,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();return d?(c("Hold still..."),d.descriptor):(c("No face detected"),null)};n==="register"?(c("Position your face in the oval"),document.getElementById("capture-face-btn")?.addEventListener("click",async()=>{c("Saving your face data...");const m=await t();if(m)try{await y(Array.from(m)),a("SUCCESS"),setTimeout(l,2e3)}catch(k){a("ERROR"),s(k.message||"Failed to save face data.")}})):(c("Position your face in the oval"),o.current=window.setInterval(async()=>{const d=await t();if(d){clearInterval(o.current),c("Verifying...");try{const N=await D.collection("users").where("email","==",u.trim()).limit(1).get();if(N.empty||!N.docs[0].data().faceDescriptor)throw new Error("Face Login is not set up for this account.");const F=new Float32Array(N.docs[0].data().faceDescriptor);faceapi.euclideanDistance(F,d)<.5?(c("Face matched! Logging in..."),await w(u),a("SUCCESS"),setTimeout(l,1500)):(a("ERROR"),s("Face not recognized. Please try again."))}catch(m){a("ERROR"),s(m.message||"Verification failed.")}}},2e3))},[u,l,w,n,y]);r.useEffect(()=>{h==="CAMERA_ACTIVE"&&i.current&&(i.current.onloadedmetadata=()=>{C()})},[h,C]);const A=t=>{if(t.preventDefault(),!u.trim()){s("Email address is required.");return}s(""),a("CAMERA_ACTIVE")},S=()=>{switch(h){case"INITIALIZING":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-brand-red mx-auto"}),e.jsx("p",{className:"mt-4",children:"Initializing..."})]});case"AWAITING_PERMISSION":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(U,{className:"h-12 w-12 mx-auto text-blue-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Enable Camera Access"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"We need your permission to use the camera for face recognition."}),e.jsx("button",{onClick:R,className:"mt-6 w-full bg-brand-red text-white font-bold py-2.5 rounded-md",children:"Grant Permission"})]});case"PERMISSION_DENIED":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(_,{className:"h-12 w-12 mx-auto text-red-500 mb-4"}),e.jsx("h3",{className:"font-bold text-lg",children:"Camera Access Denied"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"Please enable camera access in your browser's site settings and try again."}),e.jsx("button",{onClick:l,className:"mt-6 w-full bg-gray-600 text-white font-bold py-2.5 rounded-md",children:"Close"})]});case"EMAIL_INPUT":return e.jsxs("form",{onSubmit:A,className:"p-6 space-y-4",children:[e.jsx("h3",{className:"font-bold text-center",children:"Log In with Face ID"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"face-login-email",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Email Address"}),e.jsx("input",{type:"email",id:"face-login-email",value:u,onChange:t=>j(t.target.value),required:!0,className:"w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-black",placeholder:"you@example.com"})]}),b&&e.jsx("p",{className:"text-sm text-red-500 text-center",children:b}),e.jsx("button",{type:"submit",className:"w-full bg-brand-red text-white font-bold py-2.5 rounded-md hover:bg-brand-red-dark",children:"Continue"})]});case"CAMERA_ACTIVE":return e.jsxs("div",{className:"p-6 text-center",children:[e.jsxs("div",{className:"relative w-full max-w-[256px] h-auto aspect-[3/4] mx-auto bg-black rounded-lg overflow-hidden border border-gray-300 dark:border-gray-700",children:[e.jsx("video",{ref:i,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover transform -scale-x-100"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-[70%] h-[80%] border-4 border-white/50 rounded-[50%] animate-pulse-glow"})})]}),e.jsx("p",{className:"mt-4 font-semibold h-5",children:v}),n==="register"&&e.jsx("button",{id:"capture-face-btn",className:"w-full mt-4 bg-brand-red text-white font-bold py-2 rounded-md",children:"Capture Face"})]});case"SUCCESS":return e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("h3",{className:"font-bold text-lg text-green-600",children:"Success!"}),e.jsx("p",{className:"mt-2",children:n==="register"?"Face Login has been enabled.":"You are now logged in."})]});case"ERROR":return e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("h3",{className:"font-bold text-lg text-red-500",children:"An Error Occurred"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:b}),e.jsxs("button",{onClick:p,className:"mt-4 flex items-center justify-center gap-2 w-full bg-gray-200 dark:bg-gray-700 font-bold py-2.5 rounded-md",children:[e.jsx(T,{className:"h-5 w-5"})," Try Again"]})]});default:return null}};return n==="signup_redirect"&&f?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl p-6 text-center",onClick:t=>t.stopPropagation(),children:[e.jsx(L,{className:"h-10 w-10 mx-auto text-brand-red mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Set Up Face Login After Sign Up"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["Please complete the sign-up process first. You can then enable Face Login from your ",e.jsx("strong",{children:"Account Settings"})," page."]}),e.jsx("button",{onClick:l,className:"mt-4 w-full bg-brand-red text-white font-bold py-2 px-4 rounded-md",children:"Got it"})]})}):f?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4",onClick:l,children:e.jsxs("div",{className:"bg-white dark:bg-black w-full max-w-sm rounded-lg shadow-xl",onClick:t=>t.stopPropagation(),children:[e.jsxs("header",{className:"flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsx("h2",{className:"text-xl font-bold",children:n==="register"?"Set Up Face Login":"Continue with Face ID"}),e.jsx("button",{onClick:l,className:"text-gray-500 hover:text-gray-800",children:e.jsx(M,{className:"h-6 w-6"})})]}),S()]})}):null};export{V as F};
